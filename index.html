<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>매장 지도 검색 서비스</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Nanum+Gothic:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Nanum Gothic', sans-serif;
            background-color: #2c2f38;
            color: #fff;
            margin: 0;
        }

        #map {
            width: 100%;
            height: 80vh;
        }

        #search-container {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #444;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.4);
            z-index: 1000;
            border-radius: 5px;
            width: 300px;
            text-align: center;
            color: #fff;
        }

        #search-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #666;
            border-radius: 5px;
            font-size: 14px;
            background-color: #333;
            color: #fff;
        }

        #search-results {
            max-height: 250px;
            overflow-y: auto;
            margin-top: 10px;
            border: 1px solid #666;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            background-color: #333;
            font-size: 14px;
        }

        .search-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #444;
        }

        .search-item:hover {
            background-color: #555;
        }

        .store-info {
            display: block;
            color: #bbb;
            margin-top: 5px;
            font-size: 13px;
        }

        .store-name {
            font-weight: bold;
            font-size: 16px;
        }

        #tile-selector {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .tile-button {
            width: 40px;
            height: 40px;
            margin-bottom: 5px;
            border: none;
            background-size: cover;
            background-position: center;
            cursor: pointer;
            border-radius: 5px;
        }

        #osm-btn {
            background-image: url('https://upload.wikimedia.org/wikipedia/commons/a/a1/OpenStreetMap_logo.svg');
        }

        #carto-btn {
            background-image: url('https://carto.com/static/img/carto-logo.svg');
        }

        #stamen-btn {
            background-image: url('https://stamen.com/wp-content/uploads/2020/06/2017-Stamen-Logo.png');
        }

    </style>
</head>
<body>

    <div id="search-container">
        <input type="text" id="search-input" placeholder="매장명, 전화번호, 메뉴 검색" />
        <div id="search-results"></div>
    </div>

    <!-- 지도 스타일 선택 버튼 (이미지 버튼으로 변경) -->
    <div id="tile-selector">
        <button id="osm-btn" class="tile-button" title="OpenStreetMap" style="background-image: url('https://upload.wikimedia.org/wikipedia/commons/b/b0/Openstreetmap_logo.svg');"></button>
        <button id="satellite-btn" class="tile-button" title="Satellite" style="background-image: url('https://upload.wikimedia.org/wikipedia/commons/b/bd/Google_Maps_Logo_2020.svg');"></button>
    </div>

    <div id="map"></div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <script>
        // 지도 초기화
        const map = L.map('map').setView([37.5665, 126.978], 12); // 서울 위치로 설정 (위도, 경도)

        // 기본 OpenStreetMap TileLayer 추가
        const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // 위성지도 TileLayer 추가 (Esri 위성지도 사용)
        var esri_url = 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}';
        var esri_attribution = '© Esri © OpenStreetMap Contributors';

        const satelliteLayer = L.tileLayer(esri_url, {id: 'MapID', maxZoom: 20, tileSize: 512, zoomOffset: -1, attribution: esri_attribution});

        // 기본 타일 레이어 설정
        let currentLayer = osmLayer;

        // 타일 스타일 변경 버튼 클릭 시 지도 스타일 변경
        $('#osm-btn').on('click', function() {
            map.removeLayer(currentLayer);
            currentLayer = osmLayer;
            map.addLayer(currentLayer);
        });

        $('#satellite-btn').on('click', function() {
            map.removeLayer(currentLayer);
            currentLayer = satelliteLayer;
            map.addLayer(currentLayer);
        });

        // 지도 스케일 표시
        L.control.scale().addTo(map);

        let storeData = [];
        let storeMarkers = [];

        // CSV 파일 불러오기
        Papa.parse('stores.csv', {
            download: true,
            header: true,
            skipEmptyLines: true,
            dynamicTyping: true,
            complete: function(results) {
                storeData = results.data;
                storeData.forEach(store => {
                    addStoreMarker(store);
                });
            }
        });

        // 매장 아이콘 설정 (빨간색)
        function getStoreIcon() {
            return L.icon({
                iconUrl: 'https://upload.wikimedia.org/wikipedia/commons/8/88/Red_pin_icon.svg',  // 빨간색 아이콘
                iconSize: [30, 30],
                iconAnchor: [15, 30],
                popupAnchor: [0, -30]
            });
        }

        // 매장 마커 추가
        function addStoreMarker(store) {
            const lat = store.latitude;
            const lon = store.longitude;
            const marker = L.marker([lat, lon], {icon: getStoreIcon()}).addTo(map);

            marker.storeInfo = store;
            storeMarkers.push(marker);

            marker.on('click', function() {
                // 여러 음식점이 동일 위치에 있을 경우, 팝업을 리스트로 전환
                const nearbyStores = storeMarkers.filter(m => m.getLatLng().equals(marker.getLatLng()));
                const storeListHTML = nearbyStores.map(m => {
                    const store = m.storeInfo;
                    return `
                        <div class="search-item" onclick="showStoreInfo(${store.id})">
                            <span class="store-name">${store.name}</span>
                            <div class="store-info"><strong>전화:</strong> ${store.phone}</div>
                            <div class="store-info"><strong>메뉴:</strong> ${store.menu}</div>
                        </div>
                    `;
                }).join('');
                
                // 리스트를 팝업으로 표시
                marker.bindPopup(storeListHTML).openPopup();
            });
        }

        function showStoreInfo(id) {
            const store = storeData.find(s => s.id === id);
            alert(`매장: ${store.name}\n전화: ${store.phone}\n메뉴: ${store.menu}`);
        }

        // 실시간 검색 처리
        $('#search-input').on('input', function() {
            const query = $(this).val().toLowerCase();
            const results = storeData.filter(store =>
                store.name.toLowerCase().includes(query) ||
                store.phone.toLowerCase().includes(query) ||
                store.menu.toLowerCase().includes(query)
            );

            $('#search-results').empty();
            if (results.length > 0) {
                results.forEach(store => {
                    const resultItem = $('<div>')
                        .addClass('search-item')
                        .html(`
                            <span class="store-name">${store.name}</span>
                            <div class="store-info"><strong>전화:</strong> ${store.phone}</div>
                            <div class="store-info"><strong>메뉴:</strong> ${store.menu}</div>
                        `)
                        .on('click', function() {
                            map.setView([store.latitude, store.longitude], 14);
                            const marker = storeMarkers.find(m => m.storeInfo === store);
                            marker.openPopup();
                        });
                    $('#search-results').append(resultItem);
                });
            } else {
                $('#search-results').append('<div>검색 결과가 없습니다.</div>');
            }
        });
    </script>

</body>
</html>
